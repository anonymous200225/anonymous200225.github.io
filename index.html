<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#fff">

  <title>ESS - Kehadiran & Lembur</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      user-select: none;
    }

    html, body {
      width: 100%;
      overflow-x: hidden;
      max-width: 100vw;
    }

    body {
      font-family: sans-serif;
      background: #000;
      color: black;
*      padding: 0px;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      background: #eee;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 16%;
    }

    h3 {
      text-align: center;
      margin-bottom: 15px;
    }

    #fileInput {
      background: rgba(0,100,0,0.8);
      color: white;
      border: 1px solid rgba(0,0,0,0.3);
      border-radius: 8px;
      font-weight: bold;
      width: 96%;
      padding: 2%;
      margin: 0 2%;
      margin-bottom: 0.5%;
    }

    .summary-table, .data-table {
      border-collapse: collapse;
      border-spacing: 0;
      width: 100%;
      margin-top: 12px;
    }

    .summary-table, .data-table, input-form {
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .data-table th, .data-table td {
      padding: 5px;
      text-align: center;
    }

    .summary-table tr, .data-table tr{
      border: 1px solid #bbb;
    }

    .summary-table th {
      background: #4CAF50;
      color: white;
      font-weight: bold;
      padding: 8px;
      font-size: 15px;
    }

    .summary-table td {
      background: #ddd;
      text-align: left;
      font-weight: bold;
      padding: 10px;
      font-size: 13px;
    }

    .data-table th {
      background: #4CAF50;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    .data-table td {
      font-size: 11px;
      font-weight: bold;
    }

    .data-table tr.abs td {
      background: #ffff99 !important;
    }

    .data-table tr.wd td {
      background: #c0ffc0;
    }

    .data-table tr.off td {
      background: #ffcccc;
    }

    .data-table tr.phoff td {
      background: #ffbbbb;
    }

    .data-table tr.ct td {
      background: #ddffdd;
    }

    .delBtn {
      border: 1px solid #aaa;
      border-radius: 50%;
      padding: 4px;
      font-weight: bold;
      background: #fdd;
      color: black;
    }

    .table-responsive {
      overflow-x: auto;
    }

.input-form {
  border-collapse: collapse;
  max-width: 500px;
  width: 100%;
  background: #ddd;
}

.input-form th {
  padding: 15px;
  border: 1px solid #888;
  background: #4CAF50;
  color: white;
  font-size: 14px;
}

.input-form td {
  font-size: 10px;
  font-weight: bold;
  padding: 15px;
  width: 100%;
  border: 1px solid #bbb;
  text-align: center;
}

.input-form input, .input-form select {
  border: 1px solid #bbb;
  border-radius: 8px;
  width: 200px;
  font-size: 13px;
  padding: 5px;
  font-weight: bold;
  background: rgba(255,255,255,0.7);
  color: black;
  padding-left: 8px;
  outline: none;
  box-shadow: none;
}

.input-form button {
  width: 100%;
  height: 35px;
  font-weight: bold;
  background: rgba(0,100,0,0.8);
  border: 1px solid #ccc;
  border-radius: 5px;
  color: white;
}

.input-form label {
  align-items: center;
  gap: 5px;
  margin-bottom: 4px;
  font-size: 13px;
}

.input-form input[type="radio"],
.input-form input[type="checkbox"] {
  transform: scale(1.5);
  accent-color: red;
  cursor: pointer;
}

    #tips {
      padding: 10px;
      font-size: 13px;
    }

    .kedip {
      opacity: 1;
      transition: opacity 1s ease-in-out;
    }

.header {
  position: fixed;
  top: 0;
  left: 0;
  padding-top: 3.5%;
  width: 100%;
  background: #222;
  color: white;
  z-index: 1;
}


    #load-wrapper {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #555;
      font-family: sans-serif;
    }


    #loader {
      border: 6px solid #eee;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .container {
      display: none;
    }

  </style>

    <script>
    const gaID = 'G-XY3FPZ5QKT';
  const gtagScript = document.createElement('script');
  gtagScript.async = true;
  gtagScript.src = `https://www.googletagmanager.com/gtag/js?id=${gaID}`;
  document.head.appendChild(gtagScript);

  gtagScript.onload = () => {
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', gaID);
  };
  </script>

 <script>(function(d,z,s){s.src='https://'+d+'/401/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('groleegni.net',9281223,document.createElement('script'))</script>
 <script>(function(d,z,s){s.src='https://'+d+'/401/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('groleegni.net',9482240,document.createElement('script'))</script>

</head>
<body>

  <div id="load-wrapper">
  <div id="loader"></div>
  </div>

  <div class="container">
<div class="header">
    <h3>Ringkasan Laporan<br>Kehadiran & Lembur ESS</h3>
    <hr>
  </div>

<br>

    <input type="file" id="fileInput" accept=".xls">
    <div id="tips">
      <p>
        <b class="kedip">HOW TO USE ?</b><br>
        <i>
          • Login ke akun SunFish kamu <b><a onclick="window.open('https://workplaze.dataon.com/auth', '_blank')">&gt;&gt; KLIK DISINI &lt;&lt;</a></b><br>
          • Ekspor data Laporan Kehadiran Karyawan ESS dan unduh sebagai EXCEL (.xls).<br>
          • Klik tombol <b>Pilih File</b>, lalu cari file Laporan (.xls) yang kamu unduh sebelumnya.<br><br>
        </i>
        <b class="kedip">WHATS NEW ?</b><br>
        <i>
          • Sekarang kamu bisa ubah, hapus, atau menambah data manual.<br>
          • Data otomatis tersimpan di localStorage (caching).
        </i>
      </p>
    </div>

    <div id="summaryOutput"></div>
    <div id="tableOutput"></div>

  <table class="input-form">
    <tr>
      <th colspan="2">Tambah Data</th>
      </tr>
    <tr>
      <td><label for="manualTanggal">Tanggal</label></td>
      <td><input id="manualTanggal" type="date"></td>
    </tr>
<tr>
  <td><label>Tipe Hari</label></td>
  <td>
    <label><input type="radio" name="manualTipeHari" value="WD" checked> WD</label><br>
    <label><input type="radio" name="manualTipeHari" value="OFF"> OFF</label><br>
    <label><input type="radio" name="manualTipeHari" value="PHOFF"> PHOFF</label><br>
  </td>
</tr>
    <tr>
      <td><label for="manualJamLembur">Jam Lembur</label></td>
      <td><input id="manualJamLembur" type="number" oninput="syncMenitLembur()"></td>
    </tr>
    <tr>
      <td><label for="manualMenitLembur">Menit Lembur</label></td>
      <td><input id="manualMenitLembur" type="number" oninput="syncJamLembur()"></td>
    </tr>
    <tr>
      <td><label for="manualIndeks">Indeks Lembur</label></td>
      <td><input id="manualIndeks" type="number"></td>
    </tr>
<tr>
  <td><label>Status</label></td>
  <td>
    <label><input type="radio" name="manualStatus" value="PRS" checked>PRS</label><br>
    <label><input type="radio" name="manualStatus" value="ABS">ABS</label><br>
    <label><input type="radio" name="manualStatus" value="OFF">OFF</label><br>
    <label><input type="radio" name="manualStatus" value="CT">CT</label><br>
    <label><input type="radio" name="manualStatus" value="CS">CS</label>
  </td>
</tr>
<tr>
  <td><label>Other Status</label></td>
  <td>
    <label><input type="checkbox" class="other-status" value="EAI" checked>EAI</label><br>
    <label><input type="checkbox" class="other-status" value="LTI">LTI</label><br>
    <label><input type="checkbox" class="other-status" value="NSI">NSI</label><br>
    <label><input type="checkbox" class="other-status" value="NSO">NSO</label><br>
    <label><input type="checkbox" class="other-status" value="CT">CT</label><br>
    <label><input type="checkbox" class="other-status" value="CS">CS</label><br>
    <label><input type="checkbox" class="other-status" value="ABS">ABS</label><br>
    <label><input type="checkbox" class="other-status" value="OT">OT</label><br>
    <label><input type="checkbox" class="other-status" value="OVT" checked>OVT</label><br>
    <label><input type="checkbox" class="other-status" value="PRS" checked>PRS</label><br>
    <label><input type="checkbox" class="other-status" value="PRS_MEAL" checked>PRS_MEAL</label>
  </td>
</tr>
<tr><td colspan="2">
        <button onclick="addManualEntry()">TAMBAH</button>
</tr>
</table>

    <br><hr>
    <center><span style="font-size: 14px; font-weight: bold;">&copy; Mardhi Project</span></center>
  </div>

<script>
const DAILY_RATE = 121592;
const OVERTIME_RATE = 17571;
const MEAL_RATE = 15000;
const potongan = 150000;

let user = localStorage.getItem("sunfishUserData");
let parsedData = [];

function saveDataToLocal() {
  localStorage.setItem("sunfishData", JSON.stringify(parsedData));
}

function loadDataFromLocal() {
  const saved = localStorage.getItem("sunfishData");
  if (saved) {
    parsedData = JSON.parse(saved);
    updateUI(parsedData);
  }
}

function parseIndonesianDate(dateStr) {
  const parts = dateStr.split('/');
  if (parts.length !== 3) return null;
  return new Date(parts[2], parts[1] - 1, parts[0]);
}

function sortDataByDate(data) {
  data.forEach(row => row.dateObj = parseIndonesianDate(row["Tanggal"]));
  data.sort((a, b) => a.dateObj - b.dateObj);
}

function calculateSalary(data) {
  let hariKerja = 0, cuti = 0, absen = 0, off = 0, totalJam = 0, totalIndeks = 0, meal = 0;
  data.forEach(row => {
    const tipe = (row["Tipe Hari"] || "").toUpperCase();
    const status = (row["Status"] || "").toUpperCase();
    const other = (row["Other Status"] || "").toUpperCase();

    if (["WD"].includes(tipe) && ["PRS"].includes(status) || ["PHOFF"].includes(tipe) && ["PRS"].includes(status)) hariKerja++;

    if (["OFF"].includes(tipe) && ["PRS"].includes(status)) off++;

    if (["CT", "CS"].includes(status)) cuti++;

    if (status === "ABS") absen++;

    if (other.includes("MEAL")) meal++;
    totalJam += parseFloat(row["Jam Lembur"]) || 0;

    totalIndeks += parseFloat((row["Indeks Lembur"] || "0").replace(",", ".")) || 0;
  });

  const gaji = ((hariKerja+cuti) * DAILY_RATE) + (totalIndeks * OVERTIME_RATE) + (meal * MEAL_RATE) - (data.length > 10 ? potongan : 0);
  return { hariKerja, cuti, absen, off, totalJam, totalIndeks, gaji };
}

function formatRupiah(number) {
  return "Rp " + Number(number).toLocaleString("id-ID");
}

function generateSummaryTable(data, start, end) {
  return `
  <table class="summary-table">
    <tr><th colspan="2">Periode: ${start} - ${end}</th></tr>
    <tr><td>Nama Karyawan</td><td>${user.nama}</td></tr>
    <tr><td>NIK / ID</td><td>${user.id}</td></tr>
    <tr><td>Posisi / Jabatan</td><td>${user.jabatan}</td></tr>
    <tr><td>Hari Kerja</td><td>${(data.hariKerja+data.off)} hari</td></tr>
    <tr><td>Cuti</td><td>${data.cuti} hari</td></tr>
    <tr><td>Absen</td><td>${data.absen} hari</td></tr>
    <tr><td>Jam Lembur</td><td>${data.totalJam.toFixed(2)} jam</td></tr>
    <tr><td>Indeks Lembur</td><td>${data.totalIndeks.toFixed(2)} jam</td></tr>
    <tr><td>Estimasi Gaji</td><td>${formatRupiah(data.gaji)}</td></tr>
  </table>`;
}


function getRowClass(row) {
  const t = (row["Tipe Hari"] || "").toUpperCase();
  const s = (row["Status"] || "").toUpperCase();

  if (s === "ABS") return "abs";
  if (s === "CT") return "ct";
  if (s === "CS") return "ct";
  if (t === "PHOFF") return "phoff";
  if (t === "OFF") return "off";
  if (t === "WD") return "wd";

  return "";
}


function generateTable(data) {
  if (data.length === 0) return "<p>Tidak ada data</p>";
  const headers = Object.keys(data[0]).filter(k => k !== "dateObj");
  let html = "<table class='data-table'><thead><tr>";
  headers.forEach(h => html += `<th>${h}</th>`);
  html += "<th>Aksi</th></tr></thead><tbody>";
  data.forEach((row, index) => {
    const rowClass = getRowClass(row);
    html += `<tr class="${rowClass}">`;
    headers.forEach(h => {
      html += `<td contenteditable onblur="editCell(${index}, '${h}', this.innerText)">${row[h]}</td>`;
    });
    html += `<td><button onclick="deleteRow(${index})" class="delBtn">❌</button></td></tr>`;
  });
  html += "</tbody></table>";
  return html;
}

function editCell(index, key, value) {
  parsedData[index][key] = value;
  saveDataToLocal();
  updateUI(parsedData);
}

function deleteRow(index) {
  if (confirm("Hapus baris ini?")) {
    parsedData.splice(index, 1);
    saveDataToLocal();
    updateUI(parsedData);
  }
}


function tanggalSekarang(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById("manualTanggal").value = `${yyyy}-${mm}-${dd}`;
}


function addManualEntry() {
  const iso = document.getElementById("manualTanggal").value;
  if (!iso) return alert("Tanggal belum diisi.");
  const [year, month, day] = iso.split("-");
  const tgl = `${day}/${month}/${year}`;
  
  const jam = parseFloat(document.getElementById("manualJamLembur").value);
  const jamValid = isNaN(jam) ? 0 : jam;
  const menit = Math.round(jamValid * 60);
  const indeks = document.getElementById("manualIndeks").value;

  const row = {
    "Tanggal": tgl,
    "Tipe Hari": document.querySelector("input[name='manualTipeHari']:checked").value,
    "Menit Lembur": menit,
    "Jam Lembur": jamValid.toFixed(2),
    "Indeks Lembur": indeks,
    "Status": document.querySelector("input[name='manualStatus']:checked").value,
    "Other Status": Array.from(document.querySelectorAll(".other-status:checked"))
      .map(cb => cb.value)
      .join(",")
  };

  parsedData.push(row);
  saveDataToLocal();
  updateUI(parsedData);

document.getElementById("manualJamLembur").value = "";
document.getElementById("manualMenitLembur").value = "";
document.getElementById("manualIndeks").value = "";

  tanggalSekarang();

  confirm("Data berhasil ditambahkan!");
}



function hitungIndeks(jam){
  const tipeHari = document.querySelector("input[name='manualTipeHari']:checked").value;

  if(tipeHari === "OFF" || tipeHari === "PHOFF"){
    return jam >= 1 ? (jam * 2) : (jam * 2);
  }

  return jam >= 1 ? (jam * 2 - 0.5) : (jam * 2);
}


let sedangSinkronJam = false;
let sedangSinkronMenit = false;

function syncMenitLembur() {
  if (sedangSinkronMenit) return;
  sedangSinkronJam = true;

  const jamInput = document.getElementById("manualJamLembur").value.trim();
  const jam = parseFloat(jamInput);

  if (jamInput === "" || isNaN(jam)) {
    document.getElementById("manualMenitLembur").value = "";
    document.getElementById("manualIndeks").value = "";
    sedangSinkronJam = false;
    return;
  }

  const menit = jam * 60;
  document.getElementById("manualMenitLembur").value = menit.toFixed(0);

  const indeks = hitungIndeks(jam);
  document.getElementById("manualIndeks").value = indeks.toFixed(2);

  sedangSinkronJam = false;
}


function syncJamLembur() {
  if (sedangSinkronJam) return;
  sedangSinkronMenit = true;

  const menitInput = document.getElementById("manualMenitLembur").value.trim();
  const menit = parseFloat(menitInput);

  if (menitInput === "" || isNaN(menit)) {
    document.getElementById("manualJamLembur").value = "";
    document.getElementById("manualIndeks").value = "";
    sedangSinkronMenit = false;
    return;
  }

  const jam = menit / 60;
  document.getElementById("manualJamLembur").value = jam.toFixed(2);

  const indeks = hitungIndeks(jam);
  document.getElementById("manualIndeks").value = indeks.toFixed(2);

  sedangSinkronMenit = false;
}


function updateUI(data) {
  sortDataByDate(data);
  document.getElementById("tableOutput").innerHTML = "<div class='table-responsive'>" + generateTable(data) + "</div>";
  if (data.length > 0) {
    const start = data[0]["Tanggal"], end = data[data.length - 1]["Tanggal"];
    document.getElementById("summaryOutput").innerHTML = generateSummaryTable(calculateSalary(data), start, end);
    document.getElementById("tips").style.display = "none"; // ← Sembunyikan tips jika data ada
  } else {
    document.getElementById("summaryOutput").innerHTML = "";
    document.getElementById("tips").style.display = "block"; // ← Tampilkan tips jika data kosong
  }
}


function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file.name.endsWith(".xls")) return alert("Gunakan file .xls dari ESS");
  const reader = new FileReader();
  reader.onload = function (e) {
    const doc = new DOMParser().parseFromString(e.target.result, "text/html");
    const table = doc.querySelector("table.tabGen");
    if (!table) return alert("Tabel tidak ditemukan");
    const rows = table.querySelectorAll("tbody tr");
    const result = [];
    rows.forEach(row => {
      const td = row.querySelectorAll("td");
      if (td.length < 24) return;
      const serial = parseFloat(td[0].textContent.trim());
      const date = isNaN(serial) ? td[0].textContent.trim() : new Date((serial - 25569) * 86400 * 1000).toLocaleDateString("id-ID");

if(!user){
user = {nama: td[1].textContent.trim(), id: td[2].textContent.trim(), jabatan: td[3].textContent.trim()};

localStorage.setItem("sunfishUserData", JSON.stringify(user));
}

      result.push({
        "Tanggal": date,
        "Tipe Hari": td[15].textContent.trim().toUpperCase(),
        "Menit Lembur": td[17].textContent.trim(),
        "Jam Lembur": (parseFloat(td[17].textContent.trim()) / 60).toFixed(2),
        "Indeks Lembur": td[18].textContent.trim(),
        "Status": td[21].textContent.trim(),
        "Other Status": td[22].textContent.trim()
      });
    });

    parsedData = result;
    saveDataToLocal();
    updateUI(parsedData);
  };
  reader.readAsText(file);
}

document.getElementById("fileInput").addEventListener("change", handleFileSelect);


window.onload = () => {
  user = JSON.parse(user);
  loadDataFromLocal();
  tanggalSekarang();
};


setInterval(() => {
  document.querySelectorAll(".kedip").forEach(e => {
    e.style.opacity = e.style.opacity === "1" ? "0.3" : "1";
  });
}, 1000);


    function onLoadSelesai() {
      document.querySelector(".container").style.display = "block";
      // console.log("Fungsi onLoadSelesai dipanggil!");
    }

    // Simulasi proses loading selama 3 detik
    setTimeout(() => {
      document.querySelector("#load-wrapper").style.display = "none";
      onLoadSelesai();
    }, 3000);

</script>
</body>
</html>
