<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>GPS Area - Satelit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { margin:0; padding:0; }
    #map { height: 100vh; width: 100%; }
    #info {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px 14px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 14px;
      line-height: 1.4em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 220px;
    }
    #info input, #info button {
      margin-top: 6px;
      font-size: 13px;
    }
    #info span {
      display: block;
      margin-top: 6px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="info">
  ðŸ“‚ <input type="file" id="fileInput" accept=".gpx"><br>
  <span id="luas">Luas: -</span>
  <span id="panjang">Panjang: -</span>
  <button id="downloadBtn">ðŸ“¸ Export PNG</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson@0.16.0"></script>
<script src="https://unpkg.com/@mapbox/geojson-area@0.2.2/geojson-area.js"></script>
<script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>

<script>
var map = L.map('map').setView([-6.2, 106.8], 13);
L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  attribution: 'Google Satellite'
}).addTo(map);

var luasEl = document.getElementById("luas");
var panjangEl = document.getElementById("panjang");
var luasText = "-";
var panjangText = "-";

function haversine(lat1, lon1, lat2, lon2) {
  var R = 6371000;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLon = (lon2 - lon1) * Math.PI / 180;
  var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

document.getElementById('fileInput').addEventListener('change', function(e){
  var file = e.target.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(event){
    var parser = new DOMParser();
    var gpxDoc = parser.parseFromString(event.target.result, "application/xml");
    var geojson = toGeoJSON.gpx(gpxDoc);

    var layer = L.geoJSON(geojson, {
      style: { color: 'red', weight: 4 }
    }).addTo(map);
    map.fitBounds(layer.getBounds());

    // Hitung luas
    try {
      var luasM2 = geojsonArea.geometry(geojson.features[0].geometry);
      if(luasM2 > 0){
        var luasHa = (luasM2 / 10000).toFixed(2);
        luasText = "Luas: " + luasM2.toFixed(2) + " mÂ² (" + luasHa + " ha)";
        luasEl.textContent = luasText;
      } else {
        luasText = "Luas: tidak bisa dihitung (rute belum tertutup)";
        luasEl.textContent = luasText;
      }
    } catch(err){
      luasText = "Luas: error menghitung";
      luasEl.textContent = luasText;
    }

    // Hitung panjang
    try {
      var coords = geojson.features[0].geometry.coordinates;
      var total = 0;
      for (var i = 0; i < coords.length - 1; i++) {
        var lon1 = coords[i][0], lat1 = coords[i][1];
        var lon2 = coords[i+1][0], lat2 = coords[i+1][1];
        total += haversine(lat1, lon1, lat2, lon2);
      }
      if (total > 0) {
        if (total > 1000) {
          panjangText = "Panjang: " + (total/1000).toFixed(2) + " km";
        } else {
          panjangText = "Panjang: " + total.toFixed(2) + " m";
        }
        panjangEl.textContent = panjangText;
      } else {
        panjangText = "Panjang: -";
        panjangEl.textContent = panjangText;
      }
    } catch(err){
      panjangText = "Panjang: error menghitung";
      panjangEl.textContent = panjangText;
    }
  };
  reader.readAsText(file);
});

// Export ke PNG dengan teks tambahan
document.getElementById('downloadBtn').addEventListener('click', function(){
  leafletImage(map, function(err, canvas) {
    var ctx = canvas.getContext("2d");
    ctx.fillStyle = "rgba(255,255,255,0.7)";
    ctx.fillRect(10, 10, 340, 50);

    ctx.fillStyle = "black";
    ctx.font = "16px sans-serif";
    ctx.fillText(luasText, 20, 30);
    ctx.fillText(panjangText, 20, 50);

    var img = canvas.toDataURL("image/png");
    var link = document.createElement("a");
    link.href = img;
    link.download = "peta.png";
    link.click();
  });
});
</script>
</body>
</html>
